<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JACOB'S ARCADE V3</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{
  --neon-blue:#00e6ff;
  --neon-green:#7cff00;
  --bg-color:#05030a;
  --card-bg:rgba(255,255,255,0.02);
  --text:#e6faff;
  --muted: rgba(255,255,255,0.18);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;font-family:"Press Start 2P",Arial,sans-serif;color:var(--text);background:var(--bg-color);overflow-x:hidden}
header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:rgba(0,0,0,0.25);border-bottom:1px solid rgba(255,255,255,0.04);position:relative;z-index:30}
.logo{width:48px;height:48px;background:linear-gradient(135deg,var(--neon-blue),var(--neon-green));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#001;font-weight:700}
.games{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin:24px}
.game-card{background:var(--card-bg);padding:12px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,0.03);transition:transform .15s,box-shadow .15s}
.game-card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 8px 24px rgba(0,200,255,0.06)}
.card-buttons{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
button, .btn {
  font-size:10px;padding:6px 8px;cursor:pointer;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--neon-blue);text-transform:uppercase;
}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
#deploy-proxy-btn{
  position:fixed;left:50%;top:8px;transform:translateX(-50%);z-index:40;padding:8px 14px;border-radius:10px;background:linear-gradient(90deg,var(--neon-blue),var(--neon-green));color:#001;font-weight:700;cursor:pointer;border:none;box-shadow:0 6px 18px rgba(0,0,0,0.4)
}
#proxy-overlay{
  position:fixed;inset:0;background:#000;display:none;z-index:10000;align-items:stretch;justify-content:stretch;overflow:hidden
}
#proxy-iframe{width:100%;height:100%;border:0;background:white}
#proxy-back{
  position:fixed;left:12px;top:12px;z-index:11000;border-radius:8px;padding:8px 10px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.06);cursor:pointer;color:var(--neon-green)
}
#custom-panel{position:fixed;top:0;right:-360px;width:340px;height:100%;background:rgba(0,0,0,0.9);padding:18px;border-radius:10px 0 0 10px;box-shadow:-4px 0 20px rgba(0,0,0,0.5);transition:right .28s ease;z-index:1000}
#custom-panel.open{right:0}
.panel-section{margin-bottom:14px}
.panel-section label{display:block;margin-bottom:6px;font-size:12px;color:var(--muted)}
input[type=color],input[type=text],select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);color:var(--text)}
.small{font-size:11px;padding:4px}
.loading-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);z-index:2000;backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .18s}
.loading-overlay.show{opacity:1;pointer-events:auto}
.loading-box{width:min(560px,92%);background:rgba(255,255,255,0.03);padding:18px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.06)}
.loading-message{font-size:12px;margin-bottom:12px}
.progress{height:8px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden}
.progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--neon-blue),var(--neon-green));transition:width .2s}
.header-row{display:flex;gap:12px;align-items:center}
.search{margin:18px}
.favorite{cursor:pointer;opacity:.95}
.banner{padding:8px;background:linear-gradient(90deg,rgba(0,0,0,0.4),rgba(255,255,255,0.02));text-align:center;margin:12px 24px;border-radius:8px}
.footer{padding:12px;text-align:center;font-size:12px;opacity:.9}
.auth-box{display:flex;flex-direction:column;gap:8px;align-items:center}
.auth-box input{width:260px;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text)}
.note{font-size:10px;color:var(--muted);margin-top:8px;text-align:center}

/* ---- Logged-in look (from screenshot) ---- */
body.logged-in {
  background: radial-gradient(circle at 10% 10%, rgba(0,230,255,0.03), transparent 8%),
              radial-gradient(circle at 90% 80%, rgba(124,255,0,0.02), transparent 12%),
              var(--bg-color);
}
body.logged-in header { padding: 22px 36px; }
body.logged-in .logo { width:64px; height:64px; font-size:20px; border-radius:12px; box-shadow:0 8px 30px rgba(0,230,255,0.06) }
body.logged-in h1 { font-size:20px; letter-spacing:2px }
body.logged-in #deploy-proxy-btn{
  top:18px; padding:12px 22px; font-size:13px; border-radius:14px; box-shadow:0 8px 36px rgba(0,230,255,0.08), 0 0 0 3px rgba(0,230,255,0.03) inset;
}
body.logged-in .search input{
  padding:14px 18px; font-size:13px; border-radius:12px; background: rgba(0,0,0,0.45); border:1px solid rgba(0,230,255,0.06); color:var(--neon-blue);
}
body.logged-in .games { grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:18px; margin:28px 36px; }
body.logged-in .game-card{ border-radius:12px; padding:14px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(0,230,255,0.05); box-shadow: 0 6px 22px rgba(0,0,0,0.6); }
body.logged-in .card-buttons button{ padding:8px 10px; font-size:11px; border-radius:8px; background: rgba(0,0,0,0.5); color: var(--neon-blue); }
body.logged-in .favorite.active { color: var(--neon-green); text-shadow:0 4px 12px rgba(124,255,0,0.08) }
@media(max-width:880px){#custom-panel{width:86%}}
</style>
</head>
<body>
<header>
  <div class="header-row">
    <div class="logo">J²</div>
    <div>
      <h1 style="font-size:16px;color:var(--neon-blue);letter-spacing:1px">JACOB'S ARCADE V3</h1>
      <div id="banner-text" style="font-size:10px;color:var(--neon-green);text-transform:uppercase">WELCOME</div>
    </div>
  </div>

  <div class="header-row" style="gap:10px;">
    <div id="clock" style="font-size:12px;color:var(--neon-green);text-transform:uppercase">00:00:00</div>
    <button id="customize-btn" class="btn">CUSTOMIZE</button>
  </div>
</header>

<!-- Deploy Proxy Button (center top) -->
<button id="deploy-proxy-btn" title="Deploy Proxy">DEPLOY PROXY</button>

<!-- Proxy overlay (hidden until deploy clicked) -->
<div id="proxy-overlay" aria-hidden="true">
  <button id="proxy-back" title="Back to Arcade">← BACK</button>
  <iframe id="proxy-iframe" src="" frameborder="0" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
</div>

<!-- LOGIN + SIGNUP OVERLAY -->
<div id="login-screen" style="position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:5000;display:flex;align-items:center;justify-content:center;flex-direction:column;color:white;font-family:'Press Start 2P';">
 <div style="text-align:center;">
   <h2 style="margin-bottom:14px;">LOGIN</h2>
   <div class="auth-box">
     <input id="login-username" type="text" placeholder="USERNAME">
     <input id="login-password" type="password" placeholder="PASSWORD">
     <div style="display:flex;gap:8px;margin-top:6px">
       <button id="login-btn" class="btn">LOGIN</button>
       <button id="show-signup-btn" class="btn">SIGN UP</button>
     </div>
     <div id="login-error" style="color:#ff6b6b;font-size:12px;margin-top:8px;display:none;">Wrong username or password</div>
     <div class="note">Local-only demo auth (passwords hashed client-side)</div>
   </div>
 </div>
</div>

<div id="signup-screen" style="position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:5000;display:none;align-items:center;justify-content:center;flex-direction:column;color:white;font-family:'Press Start 2P';">
 <div style="text-align:center;">
   <h2 style="margin-bottom:14px;">SIGN UP</h2>
   <div class="auth-box">
     <input id="signup-username" type="text" placeholder="CREATE USERNAME">
     <input id="signup-password" type="password" placeholder="CREATE PASSWORD">
     <div style="display:flex;gap:8px;margin-top:6px">
       <button id="create-account-btn" class="btn">CREATE</button>
       <button id="show-login-btn" class="btn">BACK</button>
     </div>
     <div id="signup-error" style="color:#ff6b6b;font-size:12px;margin-top:8px;display:none;">Username already exists</div>
     <div class="note">Passwords are hashed with SHA-256 before saving (client-side)</div>
   </div>
 </div>
</div>

<div id="access-granted" style="position:fixed;inset:0;background:black;z-index:6000;color:lime;font-family:'Press Start 2P';display:none;align-items:center;justify-content:center;font-size:22px;">
 ACCESS GRANTED
</div>

<div class="banner" id="custom-banner">Press PLAY to start a game — loading messages are chaotic!</div>

<div style="display:flex;gap:18px">
  <div style="flex:1">
    <div class="search"><input id="search-games" type="text" placeholder="SEARCH GAMES..." style="width:100%;padding:8px;border-radius:6px"></div>
    <div class="games" id="games"></div>
  </div>

  <div id="custom-panel">
    <h3 style="color:var(--neon-green);margin-bottom:12px">CUSTOMIZE</h3>
    <div class="panel-section">
      <label>Theme Presets</label>
      <select id="theme-preset">
        <option value="neon">Neon (default)</option>
        <option value="retro">Retro</option>
        <option value="sunset">Sunset</option>
      </select>
    </div>
    <div class="panel-section">
      <label>Neon Color</label>
      <input type="color" id="neon-color" value="#00e6ff">
    </div>
    <div class="panel-section">
      <label>Background Color</label>
      <input type="color" id="bg-color" value="#05030a">
    </div>
    <div class="panel-section">
      <label>Grid Size</label>
      <select id="grid-size"><option value="small">Small cards</option><option value="medium" selected>Medium cards</option><option value="large">Large cards</option></select>
    </div>
    <div class="panel-section">
      <label><input type="checkbox" id="toggle-clock" checked> Show Live Clock</label>
      <label><input type="checkbox" id="toggle-verse" checked> Show Verse Box</label>
    </div>
    <div class="panel-section">
      <label>Custom Banner Text</label>
      <input type="text" id="banner-input" placeholder="Type a banner message...">
      <button id="save-banner" class="small">Save Banner</button>
    </div>
    <div class="panel-section">
      <label>Favorites</label>
      <div style="font-size:12px">Click the ⭐ on any game card to favorite it. Use the filter below.</div>
      <button id="show-faves" class="small">Show Favorites</button>
      <button id="clear-faves" class="small">Clear Favorites</button>
    </div>
    <div class="panel-section">
      <label>Reset to defaults</label>
      <button id="reset-prefs" class="small">RESET</button>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loading-overlay" aria-hidden="true">
  <div class="loading-box" role="status" aria-live="polite">
    <div class="loading-message" id="loading-message">Loading...</div>
    <div class="progress"><i id="loading-bar"></i></div>
    <div style="margin-top:10px;font-size:11px;color:rgba(255,255,255,0.7)">This sometimes takes 0.5–3s (simulated)</div>
  </div>
</div>

<div class="footer">FOLLOW — YOUTUBE / TWITCH / TIKTOK</div>

<script>
/* ----------------- CORE DATA ----------------- */
const GAME_FILES = [
"1v1lol.html","amanda.html","aquapark.html","bad-parenting-1.html","baldis-basics.html",
"baseball-bros.html","basket-bros.html","bitlife.html","block-blast.html","bowmasters.html",
"buildnow.gg.html","clash-of-vikings.html","cuphead-1.html","do-not-take-this-cat-home.html",
"fears-to-fathom-home-alone.html","flip-master.html","football-bros.html","friday-night-funkin.html",
"justfall.lol.html","kindergarten.html","kindergarten-2.html","kindergarten-3.html",
"minecraft-1.21.4.html","retro-bowl.html","run-1.html","run-2.html","run-3.html",
"schoolboy-runaway.html","slither.io.html","slope.html","sonic-mania.html",
"sonic-the-hedgehog-2-communitys-cut.html","sonic-the-hedgehog-3-angel-island-remastered.html",
"sonic.exe.html","steal-brainrot-online.html","stickman-fight-ragdoll.html","stickman-hook.html",
"subway-surfers-barcelona.html","super-mario-bros.html","supreme-duelists.html"
];

const LOADING_MESSAGES = [
"Loading... bruh the hamster fell off the wheel","Game is booting up... it’s lagging like your WiFi",
"Hold on, the pixels are arguing again","Loading... your PC is crying but it’ll be okay",
"Bringing snacks for the CPU","Summoning the joystick spirits","Polishing the high scores",
"Tightening sprites' shoelaces","Applying duct tape to the physics engine","Feeding the binary hamsters",
"Charging the fun capacitor","Warming up the magenta pixels","Checking for missing semicolons",
"Negotiating with the browser for extra RAM","Borrowing energy from Pluto","Asking the clouds for frames per second",
"Whispering to the WASM gods","Convincing the fonts to cooperate","Debugging with a rubber chicken",
"Loading... the snail courier is almost there","Tuning the retro synths","Infusing code with extra vibes",
"Making sure the hero has a cool hat","Applying anti-glitch stickers","Rebooting the imagination module",
"Searching for lost pixels","Shouting encouragement at the CPU","Packing parachutes for sprites",
"Latent meme retrieval in progress","Adjusting gravity to moderate","Upgrading the fun meter to max",
"One moment while we summon the fun!"
];

/* ----------------- UTILS ----------------- */
function randFrom(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function wait(ms){ return new Promise(r=>setTimeout(r,ms)) }

/* ----------------- PERSISTENCE / PREFS ----------------- */
const prefs = {
  neon: localStorage.getItem('pref-neon') || '#00e6ff',
  bg: localStorage.getItem('pref-bg') || '#05030a',
  banner: localStorage.getItem('pref-banner') || 'Welcome to the arcade!',
  grid: localStorage.getItem('pref-grid') || 'medium',
  showClock: localStorage.getItem('pref-clock')==='false'?false:true,
  showVerse: localStorage.getItem('pref-verse')==='false'?false:true,
  favs: JSON.parse(localStorage.getItem('pref-favs')||'[]')
}

/* ----------------- RENDERING ----------------- */
const gamesDiv = document.getElementById('games');

function buildCard(fname){
  const card = document.createElement('div');
  card.className='game-card';
  const title = fname.replace(/\.html$/,'').replace(/[-\.]/g,' ').toUpperCase();
  const id = fname;
  const star = document.createElement('span');
  star.innerHTML = prefs.favs.includes(id)?'⭐':'☆';
  star.className='favorite';
  star.title='Toggle favorite';
  star.style.marginLeft='6px';
  star.onclick = (e)=>{ e.stopPropagation(); toggleFav(id); star.innerHTML = prefs.favs.includes(id)?'⭐':'☆'; star.classList.toggle('active', prefs.favs.includes(id)); };
  card.innerHTML = `<div style="font-size:12px">${title}</div>`;
  const btns = document.createElement('div'); btns.className='card-buttons';

  const play = document.createElement('button'); play.textContent='PLAY';
  play.onclick = ()=> { window.location.href = id; }; // same-tab

  const openBlank = document.createElement('button'); openBlank.textContent='ABOUT:BLANK';
  openBlank.onclick = async (e)=> {
    e.stopPropagation();
    try {
      const w = window.open('about:blank');
      if(!w) { alert('Popup blocked. Allow popups for this site.'); return; }
      const res = await fetch(id);
      const txt = await res.text();
      const blob = new Blob([txt], {type:'text/html'});
      const blobUrl = URL.createObjectURL(blob);
      const doc = w.document;
      doc.open();
      doc.write(`<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>html,body{height:100%;margin:0;background:#000}iframe{border:0;width:100%;height:100%}</style></head><body><iframe src="${blobUrl}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe></body></html>`);
      doc.close();
    } catch(err){ console.error(err); alert('Failed to open ABOUT:BLANK'); }
  };

  const blob = document.createElement('button'); blob.textContent='BLOB LINK';
  blob.onclick = ()=> fetch(id).then(r=>r.text()).then(t=>{const blob2=new Blob([t],{type:'text/html'});window.open(URL.createObjectURL(blob2),'_blank')});

  btns.append(play,openBlank,blob);
  card.appendChild(btns);
  card.appendChild(star);
  return card;
}

function renderGames(filter=''){
  gamesDiv.innerHTML='';
  let list = GAME_FILES.slice();
  if(filter==='favs') list = list.filter(x=>prefs.favs.includes(x));
  else if(filter && typeof filter === 'string' && filter.trim()!=='') list = list.filter(f=>f.toLowerCase().includes(filter.toLowerCase()));
  list.forEach(f=> gamesDiv.appendChild(buildCard(f)));
  applyGrid();
  // mark favorite stars visually
  document.querySelectorAll('.game-card').forEach(card=>{
    const titleTxt = card.querySelector('div').textContent.trim().toLowerCase().replace(/\s+/g,'-') + '.html';
    const star = card.querySelector('.favorite');
    if(prefs.favs.includes(titleTxt)) star.classList.add('active'); else star.classList.remove('active');
  });
}

/* ----------------- FAVORITES ----------------- */
function toggleFav(id){
  if(!prefs.favs.includes(id)) prefs.favs.push(id); else prefs.favs = prefs.favs.filter(x=>x!==id);
  localStorage.setItem('pref-favs',JSON.stringify(prefs.favs));
}

/* ----------------- LOADING + PLAY UI ----------------- */
const overlay = document.getElementById('loading-overlay');
const msgEl = document.getElementById('loading-message');
const bar = document.getElementById('loading-bar');

async function playGame(filename){
  overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
  const randomMsg = randFrom(LOADING_MESSAGES);
  msgEl.textContent = randomMsg;
  let pct = 0; bar.style.width='0%';
  const duration = 800 + Math.random()*2200;
  const start = Date.now();
  while(Date.now()-start < duration){
    const t = (Date.now()-start)/duration;
    pct = Math.min(100, Math.floor( (Math.sin(t*Math.PI/2)*0.9 + t*0.1) * 100 ));
    bar.style.width = pct + '%';
    await wait(80);
  }
  bar.style.width='100%';
  await wait(200);
  overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true');
  window.location.href = filename;
}

/* ----------------- CUSTOMIZATION BEHAVIOR ----------------- */
const customizeBtn = document.getElementById('customize-btn');
const customPanel = document.getElementById('custom-panel');
customizeBtn.addEventListener('click', (e)=>{ e.stopPropagation(); customPanel.classList.toggle('open') });
document.addEventListener('click', (e)=> { if(!customPanel.contains(e.target) && e.target !== customizeBtn) customPanel.classList.remove('open') });

const neonInput = document.getElementById('neon-color');
const bgInput = document.getElementById('bg-color');
const preset = document.getElementById('theme-preset');
const gridSize = document.getElementById('grid-size');
const toggleClock = document.getElementById('toggle-clock');
const toggleVerse = document.getElementById('toggle-verse');
const bannerInput = document.getElementById('banner-input');
const saveBanner = document.getElementById('save-banner');
const showFaves = document.getElementById('show-faves');
const clearFaves = document.getElementById('clear-faves');
const resetPrefs = document.getElementById('reset-prefs');

neonInput.addEventListener('input', ()=>{ document.documentElement.style.setProperty('--neon-blue', neonInput.value); localStorage.setItem('pref-neon',neonInput.value) });
bgInput.addEventListener('input', ()=>{ document.documentElement.style.setProperty('--bg-color', bgInput.value); document.body.style.background = bgInput.value; localStorage.setItem('pref-bg',bgInput.value) });

preset.addEventListener('change', ()=>{
  const v = preset.value;
  if(v==='neon'){ neonInput.value='#00e6ff'; bgInput.value='#05030a'; }
  if(v==='retro'){ neonInput.value='#ff6ec7'; bgInput.value='#101013'; }
  if(v==='sunset'){ neonInput.value='#ff9a3c'; bgInput.value='#201220'; }
  neonInput.dispatchEvent(new Event('input')); bgInput.dispatchEvent(new Event('input'));
});

gridSize.addEventListener('change', applyGrid);
function applyGrid(){
  const g = gridSize.value;
  if(g==='small') gamesDiv.style.gridTemplateColumns='repeat(auto-fill,minmax(140px,1fr))';
  if(g==='medium') gamesDiv.style.gridTemplateColumns='repeat(auto-fill,minmax(180px,1fr))';
  if(g==='large') gamesDiv.style.gridTemplateColumns='repeat(auto-fill,minmax(240px,1fr))';
  localStorage.setItem('pref-grid',g);
}

saveBanner.addEventListener('click', ()=>{ const t=bannerInput.value.trim(); if(t){ document.getElementById('custom-banner').textContent = t; localStorage.setItem('pref-banner',t); }});
showFaves.addEventListener('click', ()=> renderGames('favs'));
clearFaves.addEventListener('click', ()=>{ prefs.favs=[]; localStorage.setItem('pref-favs','[]'); renderGames(); });
resetPrefs.addEventListener('click', ()=>{ localStorage.clear(); location.reload(); });

/* ----------------- SEARCH ----------------- */
const searchInput = document.getElementById('search-games');
searchInput.addEventListener('input', ()=>{ renderGames(searchInput.value) });

/* ----------------- CLOCK & VERSE ----------------- */
function pad(n){ return n.toString().padStart(2,'0') }
function updateClock(){ const now=new Date(); document.getElementById('clock').textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}` }
setInterval(updateClock,1000); updateClock();

let verseBox = null;
if(prefs.showVerse){
  verseBox = document.createElement('div');
  verseBox.className='banner';
  verseBox.style.margin='12px 24px';
  verseBox.style.fontSize='11px';
  verseBox.textContent = 'THE LORD IS MY SHEPHERD; I SHALL NOT WANT - PSALM 23:1';
  document.querySelector('body').insertBefore(verseBox, document.querySelector('.footer'));
}

toggleClock.checked = prefs.showClock; toggleVerse.checked = prefs.showVerse;
toggleClock.addEventListener('change', ()=>{ localStorage.setItem('pref-clock', toggleClock.checked); document.getElementById('clock').style.display = toggleClock.checked? 'block':'none' });
toggleVerse.addEventListener('change', ()=>{ localStorage.setItem('pref-verse', toggleVerse.checked);
  if(toggleVerse.checked && !verseBox){
    verseBox = document.createElement('div'); verseBox.className='banner'; verseBox.style.margin='12px 24px'; verseBox.style.fontSize='11px';
    verseBox.textContent='THE LORD IS MY SHEPHERD; I SHALL NOT WANT - PSALM 23:1'; document.querySelector('body').insertBefore(verseBox, document.querySelector('.footer'));
  } else if(!toggleVerse.checked && verseBox){ verseBox.remove(); verseBox=null; }
});

/* ----------------- PROXY / DEPLOY V3 (persistent + restore) ----------------- */
const deployBtn = document.getElementById('deploy-proxy-btn');
const proxyOverlay = document.getElementById('proxy-overlay');
const proxyIframe = document.getElementById('proxy-iframe');
const proxyBack = document.getElementById('proxy-back');

// Use saved proxy-url or prompt on first use.
// Saves last used URL in localStorage 'proxy-url'; saves active state in 'proxy-active' (so the overlay is restored across refresh)
function showProxy(url){
  proxyIframe.src = url;
  proxyOverlay.style.display = 'flex';
  proxyOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
}

deployBtn.addEventListener('click', async (e)=> {
  e.stopPropagation();
  let url = localStorage.getItem('proxy-url') || '';
  if(!url){
    url = prompt('Enter deploy proxy URL (example: https://your-worker.workers.dev/)');
    if(!url) return;
    localStorage.setItem('proxy-url', url);
  }
  localStorage.setItem('proxy-active','1');
  showProxy(url);
});

proxyBack.addEventListener('click', (e)=> {
  e.stopPropagation();
  proxyIframe.src = 'about:blank';
  proxyOverlay.style.display = 'none';
  proxyOverlay.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
  localStorage.removeItem('proxy-active');
});

// Restore on load if user had proxy active before refresh
window.addEventListener('load', ()=>{
  const wasActive = localStorage.getItem('proxy-active') === '1';
  const saved = localStorage.getItem('proxy-url') || '';
  if(wasActive && saved){
    setTimeout(()=> showProxy(saved), 120);
  }
});

// Escape closes proxy
document.addEventListener('keydown', (e)=> {
  if(e.key === 'Escape' && proxyOverlay.style.display === 'flex'){
    proxyBack.click();
  }
});

/* ----------------- AUTH (signup/login) ----------------- */
const showSignupBtn = document.getElementById('show-signup-btn');
const showLoginBtn = document.getElementById('show-login-btn');
const loginBtn = document.getElementById('login-btn');
const createAccountBtn = document.getElementById('create-account-btn');

showSignupBtn.addEventListener('click', ()=>{ document.getElementById('login-screen').style.display='none'; document.getElementById('signup-screen').style.display='flex'; });
showLoginBtn.addEventListener('click', ()=>{ document.getElementById('signup-screen').style.display='none'; document.getElementById('login-screen').style.display='flex'; });

async function sha256hex(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

function getAccounts(){ return JSON.parse(localStorage.getItem('accounts')||'{}') }

createAccountBtn.addEventListener('click', async ()=>{
  const u = document.getElementById('signup-username').value.trim();
  const p = document.getElementById('signup-password').value;
  if(!u || !p){ document.getElementById('signup-error').textContent='Fill username & password'; document.getElementById('signup-error').style.display='block'; return; }
  const accounts = getAccounts();
  if(accounts[u]){ document.getElementById('signup-error').textContent='Username already exists'; document.getElementById('signup-error').style.display='block'; return; }
  const hash = await sha256hex(p);
  accounts[u] = hash;
  localStorage.setItem('accounts', JSON.stringify(accounts));
  document.getElementById('signup-error').style.display='none';
  alert('Account created. Please login.');
  document.getElementById('signup-screen').style.display='none';
  document.getElementById('login-screen').style.display='flex';
});

loginBtn.addEventListener('click', async ()=>{
  const u = document.getElementById('login-username').value.trim();
  const p = document.getElementById('login-password').value;
  const accounts = getAccounts();
  const hash = await sha256hex(p);
  if(!accounts[u] || accounts[u] !== hash){ document.getElementById('login-error').style.display='block'; return; }
  document.getElementById('login-error').style.display='none';
  // store last-login for UI personalization and call grantAccess
  localStorage.setItem('last-login', u);
  grantAccess(u);
});

/* ----------------- applyLoggedInUI() - the "screenshot" look ----------------- */
function applyLoggedInUI(){
  document.body.classList.add('logged-in');

  // animate the deploy button slightly
  const d = document.getElementById('deploy-proxy-btn');
  if(d){
    d.animate([
      { transform: 'translateX(-50%) scale(0.98)', boxShadow: '0 6px 18px rgba(0,0,0,0.3)' },
      { transform: 'translateX(-50%) scale(1.02)', boxShadow: '0 12px 36px rgba(0,230,255,0.12)' },
      { transform: 'translateX(-50%) scale(1)', boxShadow: '0 8px 28px rgba(0,0,0,0.4)' }
    ], { duration: 900, iterations: 1, easing: 'ease-out' });
  }

  // set banner welcome using last-login
  const last = localStorage.getItem('last-login') || '';
  if(last){
    document.getElementById('custom-banner').textContent = `WELCOME BACK — ${last.toUpperCase()}`;
  }

  // mark favorites visually
  document.querySelectorAll('.favorite').forEach(el=>{
    // find nearest card's filename (we constructed filenames to map)
    const card = el.closest('.game-card');
    if(!card) return;
    const title = card.querySelector('div')?.textContent?.trim();
    if(!title) return;
    const fname = title.toLowerCase().replace(/\s+/g,'-') + '.html';
    el.classList.toggle('active', prefs.favs.includes(fname));
  });
}

/* ----------------- grantAccess (show ACCESS GRANTED and apply UI) ----------------- */
function grantAccess(username){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('signup-screen').style.display='none';
  document.getElementById('access-granted').style.display='flex';
  // apply the logged-in UI immediately
  applyLoggedInUI();
  // hide the access message after a short moment
  setTimeout(()=>{ document.getElementById('access-granted').style.display='none'; }, 1200);
}

/* ----------------- INIT ----------------- */
(function init(){
  // apply prefs
  document.documentElement.style.setProperty('--neon-blue', prefs.neon);
  document.body.style.background = prefs.bg;
  neonInput.value = prefs.neon; bgInput.value = prefs.bg;
  bannerInput.value = prefs.banner; document.getElementById('custom-banner').textContent = prefs.banner;
  gridSize.value = prefs.grid; applyGrid();
  renderGames();

  // If user already logged in previously, apply logged-in UI
  const last = localStorage.getItem('last-login');
  if(last) applyLoggedInUI();
})();

/* ----------------- Shortcuts ----------------- */
document.addEventListener('keydown', (e)=>{ if(e.key==='f'){ renderGames('favs') } if(e.key==='/'){ searchInput.focus() } });

/* ----------------- End of script ----------------- */
</script>
</body>
</html>
